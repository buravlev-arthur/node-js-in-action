# Connect и Express

_Express_ построен на базе _Connect_. Расширяет и дополняет его, является более высокоуровневой обёрткой.

## Connect

Установка:

```bash
npm i --save connect
```

Простейшей приложение:
```javascript
// connect - это функция createServer()
const app = require('connect')();

app.use((req, res, next) => {
    res.end('Hello, World!');
});

app.listen(8080);
```

### Connect Middlewares

Функция, передаваемая в качестве параметра `app.use()` является мидлварой (middleware component). В данном случае мидлвар завершает запрос (`end()`) отправкой ответа с текстом.
Мидлвары - основа всех приложений _Connect_ и _Express_.

Мидлвара в _Connect_ - это функция с тремя параметрами:

- Объект запроса;
- Объект ответа;
- Callback-функция (обычно: `next()`), указывающая, что мидлвара завершила работу и нужно переходить к следующей.

Первым запрос получает _диспетчер_ и передаёт его первой мидлваре. Люблая мидлвара, переданая в `use()` имеет три сигнатуры:

- `cb(req, res, next)`;
- `cb(err, req, res, next)`;
- `cb(req, res)`.

Последняя используется для мидлвар, которые возвращают ответ серверу и передавать управление обратно _диспетчеру_ им не нужно. Порядок мидлваров важен.

`use()` возвращает экземляр приложения Connect(), поэтому можно использовать конвйер:

```javascript
app
    .use(middleware1)
    .use(middleware2)
    .listen(3000);
```

Настраиваемую и переиспользуемую мидлвару можно реализовать с помощью функции иницализации, которая возвращает другую функцию с замыканием:

```javascript
const setup = (options) => {
    // инициализация мидлвары
    return (req, res, next) => {
        // логика мидлвары
    }
}
```

### Обработка ошибок

1. **Обработка ошибок по-умолчанию**. Код ответа 500 - Internal Server Error. В теле - html с трассировкой ошибки;
2. **Самостоятельная обработка**. Использует сигнатуру: `cb(err, req, res, next)`. Такая мидлвара (с обработкой ошибок) устанавливается в конвейре в самом конце. Все предыдущие мидлвары в конвейере (с сигнатурами из трех или двух параметров) будут пропущены:

```javascript
app
    .use(middlewareWithError) // бросает исключение (ошибка)
    .use((req, res, next) => { ... }) // будет пропущена
    .use((req, res) => { ... }) // будет пропущена
    .use((err, req, res, next) => {
        // логика обработки ошибки
    })
```

**Пример**: ./connect-app
